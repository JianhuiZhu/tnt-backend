@startuml
actor user
user -> app: request to buy
app -> backend: /api/transaction/initiate[userEmail, gymId, merchandiseId, paymentType:wechat]
backend ->DB: search for merchandise(merchandiseId)
alt merchandise exists
DB --> backend: merchandise object
backend -> wechatPaymentAPI: request payment
wechatPaymentAPI --> backend: prepay_id
backend -> DB: create transaction object[state:pending, userId, gymId, merchandiseId, createdDate, expiryDate]
backend --> app: prepay_id, transactionObjectId
app -> wechatPaymentAPI: request payment
user -> wechatPaymentAPI: confirm payment
alt payment success
wechatPaymentAPI --> app : transaction_id
app -> backend: /api/transaction/verify/[transaction_id, transactionObjectId]
backend -> wechatPaymentAPI: verify transaction[transaction_id]
alt payment verified
backend -> DB: update transaction object[transaction_id, transactionObjectId, state:success, create QR image]
backend --> app: success[transaction object]
else payment not verified
backend -> DB: update transaction object[transaction_id, transactionObjectId, state:failed]
backend --> app: failed
end
else payment declined
app -> backend: /api/transaction/cancel/[transactionObjectId]
backend -> DB: update transaction object[transaction_id, transactionObjectId, state:canceled]
backend --> app: deleted
app -> app: canceled transaction
end
else merchandise not exists
backend -> app: Error Merchandise not found
else user not exists
backend -> app: Error User not found
else gym not exists
backend -> app: Error Gym not found
else paymentType not supported
backend -> app: Error paymentType not supported
end


@enduml